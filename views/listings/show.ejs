<% layout("/layouts/boilerplate") %>

<div class="container my-5 d-flex flex-column align-items-center">

  <h3 class="mb-4"><%= listing.title %></h3>

  <div class="card shadow" style="max-width: 700px; width: 100%;">
    <img src="<%= listing.image?.url || '/images/default.jpg' %>" 
         class="card-img-top" alt="listing image" 
         style="height: 350px; object-fit: cover; border-radius: 12px;" />

    <div class="card-body text-center">
      <ul class="list-unstyled text-start px-3">
        <li><strong>Title:</strong> <%= listing.title || 'N/A' %></li>
        <li><strong>Description:</strong> <%= listing.description || 'No description provided.' %></li>
        <li><strong>Price:</strong> ₹<%= listing.price ? listing.price.toLocaleString("en-IN") : 'N/A' %></li>
        <li><strong>Location:</strong> <%= listing.location || 'N/A' %></li>
        <li><strong>Country:</strong> <%= listing.country || 'N/A' %></li>
        <li><strong>Owner:</strong> <%= listing.owner?.username || 'Unknown' %></li>
      </ul>

      <!-- Only owner can see Edit/Delete -->
      <% if (currentUser && listing.owner && listing.owner._id.equals(currentUser._id)) { %>
        <div class="d-flex justify-content-center gap-3 mt-4">
          <a href="/listings/<%= listing._id %>/edit" class="btn btn-warning">Edit</a>
          <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
            <button type="submit" class="btn btn-danger">Delete</button>
          </form>
        </div>
      <% } %>

      <div class="col-8 mx-auto mt-4">
        <hr>
        <h4>Leave a review</h4>

        <form action="/listings/<%= listing._id %>/reviews" method="POST" novalidate>
          <div class="mb-3 mt-3 text-start">
            <label for="rating" class="form-label">Rating</label>
            <input type="range" 
                   class="form-range w-50" 
                   min="1" max="5" value="1" 
                   id="rating" 
                   name="review[rating]" />
          </div>

          <div class="mb-3 text-start">
            <label for="comment" class="form-label">Comments</label>
            <textarea name="review[comment]" 
                      id="comment" 
                      cols="30" rows="5" 
                      class="form-control"
                      required></textarea>
            <div class="invalid-feedback">Please submit your review</div>
          </div>

          <button type="submit" class="btn btn-outline-dark">Submit</button>
        </form>

        <hr>
        <h4 class="mt-4 mb-3">All Reviews</h4>

        <% if (listing.reviews.length > 0) { %>
          <div class="row row-cols-1 row-cols-md-2 g-3">
            <% listing.reviews.forEach(review => { %>
              <div class="col">
                <div class="card h-100 shadow-sm">
                  <div class="card-body">
                    <h5 class="card-title">
                      Rating: <span class="text-warning"><%= "★".repeat(review.rating) %><%= "☆".repeat(5 - review.rating) %></span>
                    </h5>
                    <p class="card-text"><%= review.comment %></p>
                  </div>

                  <!-- Only review author can delete -->
                  <div class="card-footer d-flex justify-content-between align-items-center">
                    <small class="text-muted"><%= review.createdAt.toDateString() %></small>
                    <% if (currentUser && review.author && review.author._id.toString() === currentUser._id.toString()) { %>
                      <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" 
                            onsubmit="return confirm('Are you sure you want to delete this review?');">
                        <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                      </form>
                    <% } %>
                  </div>

                </div>
              </div>
            <% }) %>
          </div>
        <% } else { %>
          <p>No reviews yet.</p>
        <% } %>

      </div>
    </div>
  </div>
</div>
